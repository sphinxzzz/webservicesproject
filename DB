USE webservices;

-- Tabela de utilizadores
CREATE TABLE Users (
    user_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('user', 'manager') DEFAULT 'user',
    is_azorean BOOLEAN DEFAULT FALSE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- Tabela de hostels
CREATE TABLE Hostels (
    hostel_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    location ENUM(
        'São Miguel', 'Terceira', 'Faial', 'Pico', 
        'São Jorge', 'Santa Maria', 'Graciosa', 
        'Flores', 'Corvo'
    ) NOT NULL,
    max_guests INT NOT NULL CHECK (max_guests > 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- Tabela de quartos
CREATE TABLE Rooms (
    room_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    hostel_id INT UNSIGNED NOT NULL,
    room_type ENUM('dormitory', 'single', 'suite') NOT NULL,
    is_available BOOLEAN DEFAULT TRUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT fk_hostel_room FOREIGN KEY (hostel_id) REFERENCES Hostels(hostel_id) ON DELETE CASCADE
);

-- Tabela de reservas
CREATE TABLE Reservations (
    reservation_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id INT UNSIGNED NOT NULL,
    room_id INT UNSIGNED NOT NULL,
    reservation_date DATE NOT NULL,
    is_discount_applied BOOLEAN DEFAULT FALSE NOT NULL,
    total_price DECIMAL(10, 2) NOT NULL CHECK (total_price >= 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT fk_user_reservation FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
    CONSTRAINT fk_room_reservation FOREIGN KEY (room_id) REFERENCES Rooms(room_id) ON DELETE CASCADE
);

-- Tabela de avaliações
CREATE TABLE Reviews (
    review_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id INT UNSIGNED,
    hostel_id INT UNSIGNED NOT NULL,
    rating INT NOT NULL CHECK (rating BETWEEN 1 AND 5),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT fk_user_review FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE SET NULL,
    CONSTRAINT fk_hostel_review FOREIGN KEY (hostel_id) REFERENCES Hostels(hostel_id) ON DELETE CASCADE
);

-- Índices para otimizar buscas
CREATE INDEX idx_hostel_location ON Hostels(location);
CREATE INDEX idx_room_availability ON Rooms(is_available);
CREATE INDEX idx_user_role ON Users(role);
CREATE INDEX idx_review_rating ON Reviews(rating);
